# S3

- Global Storage Platform
- Regional based / resilient
- Public service
	-	może być wystawiony na zewnątrz i może być dostępny za pomocą endpointów
- **EXAM** S3 jest **Private by default**
- Nadaje się do przechowywania dużej ilości danych do dystrybucji lub jako miejsce uploadu
- Powinno być używane jako input i output serwisów AWS

## Objects
- Pliki na S3
- **EXAM** Obiekt S3 może mieć od __zera__ bajtów do __5TB__
- `Object key` to jego adres w S3
- Obiekty posiadają:
	-	Version ID
	- Metadata
	- Access Control
	- Subresources
- **EXAM** Obiekt ma główne dwie częsci - key i value

## Buckets
- Pojemniki na obiekty
	- Nieskończona ilość obiektów
	- "S3 is an __object__ store - not __file__ nor __block__"
		- nie ma systemu plików, jest płaski
		- nie można go zamontować jako voluminu
	- Wszystkie obiekty są przechowywane __na tym samym poziomie__ - nie ma folderów i podfolderów, są __klucze__
	- UI i CLI przedstawi zawartość Bucketa jako foldery i podfoldery ale w rzeczywistości ma płaską strukturę
		- `folder` w języku S3 nazywa się `prefix`
		- jak `tworzymy nowy folder foo` to tak naprawdę tworzymy obiekt o nazwie `foo/`
- Nazwy Bucketów:
	- **EXAM** Nazwa Bucketu S3 musi być globalnie unique
	- **EXAM** Nazwy Bucketów S3 muszą mieć 3-63 znaki, lowercase, bez podłóg
	- **EXAM** Nazwy Bucketów S3 muszą zaczynać się od małej litery lub cyfry
	- **EXAM** Nazwy Bucketów S3 nie mogą byc formatowane jak adresy IP
- **EXAM** Konto ma soft limit do 100 Bucketów S3 i hard limit do 1000 (via support tickets)
- Istnieją w kontekście regionu
	-	Dane z Bucketu nie opuszczają regionu chyba że eksplicite to zrobimy
- Aby usunąć bucket najpierw musimy go opróźnić
	- Bukcets -> Wybrać Bucket -> Empty
	- Delete
- Bucket może mieć nałożone `Resource Policy`
	- Bucket może mieć tylko jedno Resource Policy ale może ono mieć wiele statement

## S3 Bucket Policies (Resource Policy, Security)
- Bucket S3 domyślnie tworzony jest prywany, ma do niego dostęp tylko root user konta któro go stworzyło, ale możemy go otworzyć na publiczny dostęp
- Przy tworzeniu bucketu S3 mamy opcję `Block all public access` - zaznaczenie jej __blokuje__ możliwość udostępnienia bucketu publicznie. Jak odhaczymy tę opcję to bucket nie staje się od razu publiczny ale otwiera się możliwość ustawienia go jako publicznego

### Block all public access
- Mają znaczenie tylko kiedy Anonymous Principal próbuje uzyskać dostęp do bucketu S3

## ACL Access Control List
- Pozwala na zabezpieczanie Objektów lub Bucketów
-	ACL to Subresource Objektów lub Bucketów
- Legacy feature, AWS zaleca używanie IAM Policy lub Resource Policy zamiast nich
- O wiele mniej flexible niż Policy

## Static Website Hosting
- Pozwala na dostęp do S3 via HTTP
- Musimy zdefiniować:
	- `Index document`
		- Strona wejściowa naszej strony
		- Domyślna strona na której ląduje konsument
	- `Error document`
		- Dokument który jest wyświetlony w momencie wystapienia błędu
- Po włączeniu tego AWS tworzy dla bucketu Website Endpoint którego można użyć żeby uzyskać dostęp do strony
	- Ten endpoint jest dziwny i wielki, ale możemy użyć R53 żeby stworzyć customową domenę
	- Żeby R53 mógł stworzyć taką domenę to **nazwa bucketu musi być taka sama jak domena**
		- np. domena `foo.bar.org` musi mie bucket `xxx.foo.bar.org` 

Use case:
1.	Offloading
	- Trzymanie statycznych części dynamicznej strony na S3
	- Np. obrazki, statyczne elementy
2.	Out-of-band pages
	-	Strony które powinny być dostępne w nieczęstych, nienormalnych sytuacjach
	- np. hostujemy strone na EC2, EC2 pada ale na S3 mamy statyczną stronę na którą możemy przekierować traffic

Włączenie:
1.	S3 -> stworzyć Bucket
2.	Properties -> na sam dół -> Static Website Hosting
	-	Na razie będziemy dostawać 403 bo bucket jest niedostepny publicznie
3.	Permissions -> Stworzyć opowiedni BucketPolicy
4.	Żeby mieć elegancki adres trzeba jeszcze skonfigurować Routing w Route53

## Bucket Versioning
- **EXAM** Bucket Versioning często jest na egzaminie
-	**EXAM** Raz włączonego Bucket Versioning nie można już wyłączyć!!
-	**EXAM** Object Versionig można przestawić w `SUSpended`
-	**EXAM** Suspended mozna przestawić ponownie w `Enabled`

- Każdy obiekt w S3 oprócz klucza ma też unikanle `ID`
	- `ID` jest nullem jeżeli OV jest wyłączony
- Po włączeniu OV każdy obiekt dostaje swoje ID

### Zmiany w obiekcie
-	Jeżeli zmienimy coś w danym obiekcie to poprzednia wersja obiektu dalej isniteje, nie nadpisujemy jej, pojawia się nowy obiekt o tym samym kluczu ale innym ID

### Usuwanie obiektu
- Jeżeli usuwamy obiekt bez podania `Version ID` obiektu obiekt nie zostaje tak naprawdę usunięty
	- Tworzy się tylko `Delete Marker` który przykrywa ten obiekt i sprawia że wygląda jakby został usunięty
	- Jeżeli pozbędziemy sie tego `Delete Marker` to obiekt i wszystkie jego wersje są ponownie widoczne
- Jezeli usuwamy konkretną wersję obiektu (`Version Delete`) to ta wersja usuwana jest naprawdę i nie ma już do niej dostępu

### Koszty
- Każda wersja obiektu na S3 zajmuje miejsce i płacimy za to miejsce
-	Nie da sie wyłączyć wersjonowania, można je jedynie zatrzymać tymczasowo
-	Jedyny sposób na usunięcie wersjonowania do usunięcie bucketa

## MFA Delete
- **EXAM** MFA Delete jest często na examie
- Aktywowane w konfigu Object Versioning
-	Po aktywacji MFA jest wymagane:
	-	Do każdej zmiany stanu Object Versioning
		- Przejścia z enabled na suspended itd
	- Do każdego usunięcia konkretnej wersji obietkversioned-35b23f80-e3c3-4ca9-9519-c1b6867a8eabu `Version Delete`

## Perfomance

### Single Stream Upload
- Domyślna metoda uploadu
- Pozwala na upload danych do 5GB
- Bardzo unreliable, jeżeli stracimy połączenie z internetem w 99% uploadu to musimy zacząć zupełnie od nowa

### Multipart Upload
-	Dla plików min. 100MB
- Rozbija plik na mniejsze częsci
	-	 max. 10'000 częsci po 5MB
- Sposób szybszy, bardziej reliable

### Accelerated Transfer
- Domyślnie dane podróżujące przez publiczny interned do S3 nie muszą brać najkrótkszej drogi
- Bucket S3 z włączonym Accelerated Trasnfer będzie używak AWS Edge Locations zamiast publicznego internetu i te Edge Locations mają bezpośrednie połączenie ze sobą pozwalając an szybszy transfer
